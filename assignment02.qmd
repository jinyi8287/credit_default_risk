---
title: "assignment02"
format: pdf
editor: visual
---





## Executive Summary

Executive Summary å¯èƒ½æœƒé€™æ¨£å¯«ï¼š
This report investigates the drivers of credit card churn at Tifosi Bank using predictive modelling. We identified transaction frequency and account activity as the strongest predictors of churn. By applying SMOTE and XGBoost, we improved the modelâ€™s recall to 82%. Based on our findings, we recommend that Tifosi Bank implement proactive outreach strategies for low-activity, high-limit customers to reduce attrition risk.

Introduction æœƒé€™æ¨£å¯«ï¼š
Credit card attrition represents a critical threat to Tifosi Bankâ€™s long-term profitability. With up to 25% of revenue tied to credit card operations, losing high-value customers not only reduces immediate income but undermines future cross-sell opportunities. This report investigates what drives customer churn and how analytics can inform more effective retention strategies.


## Introduction

Credit card churn has a direct impact on the profitability and strategic growth of retail banks.Credit card operations can account for up to 25% of a bankâ€™s retail revenue, driven by interest earnings, interchange fees, annual fees, and cross-selling potential of other product and service.According to McKinsey's global payments insights, credit card operations can contribute significantly up to 25% to a bank's retail revenue.

For Tifosi Bank,the rise of attrition in credit card segment signals more than a loss of revenue but also reflects a shift of customer's satisfaction or loyalty.Hence, it is crucial to identify at-risk customers and understand the key drivers of churn.

In this report, we will explore the key factors contributing to credit card churn at  Tifosi Bank by applying predictive modeling techniques.These insights are then translated into actionable strategies to support customer retention.





## Analytical Overview 




```{r,message=FALSE,warning=FALSE}
#package
library(tidyverse)
library(tidymodels)
library(janitor)
library(skimr)
library(here)
library(readr)
tidymodels_prefer()
```



```{r,message=FALSE}
#load in data
raw_data<-read_csv(here("Data","bank_churners.csv")) %>% 
  clean_names()

```


```{r}
skim(raw_data)
```


#### Data overview

The dataset from Tifosi Bank consists of 10127 credit card customers ,characterised by  three main feature groups : demographic information (e.g., age, income, education), behavioural indicators (e.g., transaction counts, credit usage), and account relationship metrics (e.g., months on book, product count).The target variable for this report is attrition_flag which is a binary indicator that represents whether the customer remained or left

#### Attrition_Flag HOW many?

```{r,message=FALSE,echo=FALSE}
ggplot(raw_data, aes(x = attrition_flag, fill = attrition_flag)) +
  geom_bar() +
  geom_text(stat = "count", aes(label = scales::percent(after_stat(count) / sum(after_stat(count)))), 
            vjust = -0.2, size = 4) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Churn is Rare, But Crucial: Only 16% Leave",
    subtitle = "Based on 10,127 credit card customers",
    x = "Customer Status",
    y = "Number of Customers"
  ) +
  theme_minimal() +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5))

```


```{r}
library(ggplot2)
library(dplyr)

# è¨ˆç®—å„é¡åˆ¥æ¯”ä¾‹
pie_data <- raw_data %>%
  count(attrition_flag) %>%
  mutate(percentage = n / sum(n),
         label = paste0(attrition_flag, ": ", scales::percent(percentage, accuracy = 0.1)))

# ç•«å‡º pie chart
ggplot(pie_data, aes(x = "", y = percentage, fill = attrition_flag)) +
  geom_col(width = 1, color = "white") +
  coord_polar(theta = "y") +
  geom_text(aes(label = label), position = position_stack(vjust = 0.5), size = 4.5) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Customer Attrition Distribution",
    fill = "Customer Status"
  ) +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 11)
  )

```


é€™è£¡æˆ‘å€‘å¾—å‡ºä¸€å€‹è³‡è¨Šï¼Œå…¶å¯¦é€šå¸¸å®¢æˆ¶æµå¤±ã€ä¿¡ç”¨æ¬ºè©ç­‰æ•¸æ“šåˆ†æå°ˆæ¡ˆéƒ½æ˜¯æ‰€è¬‚çš„ã€Œä¸å¹³è¡¡è³‡æ–™é›†ã€ï¼Œä¹Ÿå°±æ˜¯èªªæµå¤±å±¬æ–¼ã€Œç¨€å°‘äº‹ä»¶ã€ï¼Œé‚£éº¼åœ¨å¤§å‹æ•¸æ“šï¼ˆå¹¾å„„ç­†è³‡æ–™ï¼‰æˆ‘å€‘æœƒç”¨æŠ½æ¨£æ–¹æ³•ä¾†å¹³è¡¡å…©è€… ä¸éä»Šå¤©é€™ç­†è³‡æ–™é›†åªæœ‰7000å¤šï¼Œæˆ‘å€‘å¯ä»¥æ”¹ç”¨åŠ æ¬Šçš„æ–¹å¼è™•ç†ã€‚






```{r,message=FALSE,echo=FALSE}
library(forcats)
library(dplyr)
library(janitor)
library(tidyr)
library(ggplot2)

# äº¤å‰è¡¨ + ç™¾åˆ†æ¯”
income_tab <- raw_data %>%
  tabyl(income_category, attrition_flag) %>%
  adorn_percentages("row") %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(digits = 1)

income_long <- income_tab %>%
  filter(income_category != "Total") %>%
  pivot_longer(cols = -income_category, names_to = "attrition_flag", values_to = "percent")

# è¨ˆç®—å¯¦éš›ç­†æ•¸
income_counts <- raw_data %>%
  count(income_category, attrition_flag)

# åˆä½µç™¾åˆ†æ¯”èˆ‡ç­†æ•¸ï¼Œé€™æ‰æ˜¯ä½ çœŸæ­£è¦ç•«åœ–çš„è³‡æ–™æ¡†
income_plot_data <- left_join(income_counts, income_long, by = c("income_category", "attrition_flag")) %>%
  mutate(income_category = fct_relevel(income_category,
    "< $40K", "$40K - $60K", "$60K - $80K", "$80K - $120K", "> $120K", "Unknown"
  ))

# ç¹ªåœ–
ggplot(income_plot_data, aes(x = income_category, y = n, fill = attrition_flag)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = percent),
            position = position_dodge(width = 0.9), vjust = -0.3, size = 4) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Lower-income Customers Show Higher Churn Rates",
    subtitle = "Based on 10,127 credit card customers",
    x = "Income Level",
    y = "Number of Customers"
  ) +
  theme_minimal() +
  theme(legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))


```





#### card category

```{r,message=FALSE,echo=FALSE}
unique(raw_data$card_category)

# äº¤å‰è¡¨ + ç™¾åˆ†æ¯”
card_tab <- raw_data %>%
  tabyl(card_category, attrition_flag) %>%
  adorn_percentages("row") %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(digits = 1)

card_long <- card_tab %>%
  filter(card_category != "Total") %>%
  pivot_longer(cols = -card_category, names_to = "attrition_flag", values_to = "percent")


# è¨ˆç®—å¯¦éš›ç­†æ•¸
card_counts <- raw_data %>%
  count(card_category, attrition_flag)

#åˆä½µç‚ºç¹ªåœ–è³‡æ–™æ¡†
card_plot_data <- left_join(card_counts, card_long, by = c("card_category", "attrition_flag"))

#æ’åº
library(forcats)
card_plot_data <- card_plot_data %>%
  mutate(card_category = fct_relevel(card_category, "Blue", "Silver", "Gold", "Platinum"))


# ç¹ªåœ–
ggplot(card_plot_data, aes(x = card_category, y = n, fill = attrition_flag)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = percent),
            position = position_dodge(width = 0.9), vjust = -0.3, size = 4) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Customer Churn by Credit Card Category",
    subtitle = "Based on 10,127 credit card customers",
    x = "Card Category",
    y = "Number of Customers"
  ) +
  theme_minimal() +
  theme(legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```

#### income category

```{r}


# æŸ¥çœ‹é¡åˆ¥é †åº
unique(raw_data$income_category)

# å»ºç«‹äº¤å‰è¡¨ + ç™¾åˆ†æ¯”
income_tab <- raw_data %>%
  tabyl(income_category, attrition_flag) %>%
  adorn_percentages("row") %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(digits = 1)

# é•·æ ¼å¼è³‡æ–™
income_long <- income_tab %>%
  filter(income_category != "Total") %>%
  pivot_longer(cols = -income_category, names_to = "attrition_flag", values_to = "percent")

# è¨ˆç®—å¯¦éš›ç­†æ•¸
income_counts <- raw_data %>%
  count(income_category, attrition_flag)

# åˆä½µè³‡æ–™
income_plot_data <- left_join(income_counts, income_long, by = c("income_category", "attrition_flag"))

# è¨­å®šé †åº
income_plot_data <- income_plot_data %>%
  mutate(income_category = fct_relevel(income_category,
    "< $40K", "$40K - $60K", "$60K - $80K", "$80K - $120K", "> $120K", "Unknown"
  ))

# ç¹ªåœ–
ggplot(income_plot_data, aes(x = income_category, y = n, fill = attrition_flag)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = percent),
            position = position_dodge(width = 0.9), vjust = -0.3, size = 4) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Customer Churn by Income Level",
    subtitle = "Based on 10,127 credit card customers",
    x = "Income Category",
    y = "Number of Customers"
  ) +
  theme_minimal() +
  theme(legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```

ğŸ’³ Credit Card Categoryï¼ˆå¡ç‰‡é¡åˆ¥ï¼‰
ç›®æ¨™ï¼šæª¢æŸ¥ä¸åŒå¡åˆ¥ï¼ˆBlue, Silver, Gold, Platinumï¼‰æ˜¯å¦èˆ‡æµå¤±ç‡æœ‰é—œã€‚

è§€å¯Ÿï¼š

å¤§å¤šæ•¸å®¢æˆ¶é›†ä¸­åœ¨ Blue å¡ï¼Œä¸”é€™ä¸€é¡å¡çš„æµå¤±ç‡ç•¥é«˜ã€‚

Platinum é›–ç„¶äººæ•¸å°‘ï¼Œä½†æµå¤±ç‡æœ€é«˜ï¼ˆ25%ï¼‰ã€‚

è§£é‡‹ï¼šå¯èƒ½ä»£è¡¨ä½åƒ¹å€¼å®¢æˆ¶ï¼ˆBlueï¼‰æ›´å®¹æ˜“æµå¤±ï¼Œæˆ–é«˜åƒ¹å€¼å®¢æˆ¶è‹¥æµå¤±ï¼Œæœƒå¸¶ä¾†æ›´é«˜å½±éŸ¿ã€‚

ğŸ’° Income Levelï¼ˆæ”¶å…¥å±¤ç´šï¼‰
ç›®æ¨™ï¼šæŸ¥çœ‹ä¸åŒæ”¶å…¥å±¤ç´šçš„é¡§å®¢æ˜¯å¦æœ‰ä¸åŒçš„æµå¤±å‚¾å‘ã€‚

è§€å¯Ÿï¼š

å¹´æ”¶å…¥è¶Šä½çš„æ—ç¾¤ï¼Œå…¶æµå¤±ç‡è¶Šé«˜ï¼ˆä¾‹å¦‚ï¼š< $40K æœ‰ 17.2% æµå¤±ï¼‰ã€‚

æ”¶å…¥è¶Šé«˜çš„æ—ç¾¤ï¼ˆå¦‚ >$120Kï¼‰ï¼Œæµå¤±ç‡ç›¸å°ä½ã€‚

è§£é‡‹ï¼šå¯èƒ½ä»£è¡¨ç¶“æ¿Ÿèƒ½åŠ›è¼ƒå¼±è€…åœ¨ä¿¡ç”¨å¡ä½¿ç”¨èˆ‡å¿ èª åº¦ä¸Šæ›´ä¸ç©©å®šã€‚

# demographic 



#### gender

```{r,message=FALSE,echo=FALSE}
library(janitor)
library(dplyr)
library(tidyr)
library(ggplot2)

# å»ºç«‹äº¤å‰è¡¨ + ç™¾åˆ†æ¯”
gender_tab <- raw_data %>%
  tabyl(gender, attrition_flag) %>%                     # å»ºç«‹äº¤å‰è¡¨
  adorn_percentages("row") %>%                          # æ¯åˆ—å…§ç®—ç™¾åˆ†æ¯”ï¼ˆç”·è‡ªå·±ç®—ï¼Œå¥³è‡ªå·±ç®—ï¼‰
  adorn_totals("row") %>%                               # åŠ ä¸Š Total è¡Œï¼ˆå¾Œé¢æœƒéæ¿¾æ‰ï¼‰
  adorn_pct_formatting(digits = 1)                      # æ ¼å¼åŒ–ç‚º "16.0%" é€™ç¨®æ ¼å¼


# ç§»é™¤ Total è¡Œ
gender_long <- gender_tab %>%
  filter(gender != "Total") %>%
  pivot_longer(cols = -gender, names_to = "attrition_flag", values_to = "percent")

# åŠ ä¸Šç­†æ•¸ä»¥é¡¯ç¤º bar é«˜åº¦
gender_counts <- raw_data %>%
  count(gender, attrition_flag)

# åˆä½µç™¾åˆ†æ¯”èˆ‡ç­†æ•¸
gender_plot_data <- left_join(gender_counts, gender_long, by = c("gender", "attrition_flag"))

# ç¹ªåœ–
ggplot(gender_plot_data, aes(x = gender, y = n, fill = attrition_flag)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = percent),
            position = position_dodge(width = 0.9), vjust = -0.3, size = 4) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Churn Rate by Gender",
    x = "Gender",
    y = "Number of Customers"
  ) +
  theme_minimal() +
  theme(legend.title = element_blank(), plot.title = element_text(hjust = 0.5))

```

#### customer age

```{r}
ggplot(raw_data, aes(x = attrition_flag, y = customer_age, fill = attrition_flag)) +
  geom_boxplot(width = 0.5, alpha = 0.8, outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Distribution of Customer Age by Attrition",
    subtitle = "Comparing age distribution of churned vs existing customers",
    x = "Customer Status",
    y = "Customer Age"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none",
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  )

```


```{r}
ggplot(raw_data, aes(x = customer_age, fill = attrition_flag)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 30, color = "white") +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"), labels = c("Attrited", "Existing")) +
  labs(
    title = "Distribution of Customer Age by Attrition",
    x = "Customer Age",
    y = "Count",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 11)
  )

```

```{r}
# Step 1: åˆ†ç®±
raw_data <- raw_data %>%
  mutate(age_group = cut(customer_age,
                         breaks = c(20, 30, 40, 50, 60, 70),
                         labels = c("20â€“29", "30â€“39", "40â€“49", "50â€“59", "60â€“69")))

# Step 2: ç™¾åˆ†æ¯”èˆ‡ç­†æ•¸
library(janitor)

age_tab <- raw_data %>%
  tabyl(age_group, attrition_flag) %>%
  adorn_percentages("row") %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(digits = 1)

age_long <- age_tab %>%
  filter(age_group != "Total") %>%
  pivot_longer(cols = -age_group, names_to = "attrition_flag", values_to = "percent")

age_counts <- raw_data %>%
  count(age_group, attrition_flag)

age_plot_data <- left_join(age_counts, age_long, by = c("age_group", "attrition_flag"))

# Step 3: ç¹ªåœ–
ggplot(age_plot_data, aes(x = age_group, y = n, fill = attrition_flag)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = percent),
            position = position_dodge(width = 0.9), vjust = -0.3, size = 4) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Churn Rate by Age Group",
    subtitle = "Grouped by customer_age",
    x = "Age Group",
    y = "Number of Customers"
  ) +
  theme_minimal() +
  theme(
    legend.title = element_blank(),
    plot.title = element_text(hjust = 0.5),
    plot.subtitle = element_text(hjust = 0.5)
  )

```


#### education_level

```{r,message=FALSE,echo=FALSE}
# å»ºäº¤å‰è¡¨èˆ‡ç™¾åˆ†æ¯”
edu_tab <- raw_data %>%
  tabyl(education_level, attrition_flag) %>%
  adorn_percentages("row") %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(digits = 1)

edu_long <- edu_tab %>%
  filter(education_level != "Total") %>%
  pivot_longer(cols = -education_level, names_to = "attrition_flag", values_to = "percent")

edu_counts <- raw_data %>%
  count(education_level, attrition_flag)

edu_plot_data <- left_join(edu_counts, edu_long, by = c("education_level", "attrition_flag"))

# ç•«åœ–
ggplot(edu_plot_data, aes(x = education_level, y = n, fill = attrition_flag)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = percent),
            position = position_dodge(width = 0.9), vjust = -0.3, size = 4) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Customer Churn by Education Level",
    subtitle = "Based on 10,127 credit card customers",
    x = "Education Level", y = "Number of Customers"
  ) +
  theme_minimal() +
  theme(legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```


#### marital_status 

```{r,message=FALSE,echo=FALSE}
mar_tab <- raw_data %>%
  tabyl(marital_status, attrition_flag) %>%
  adorn_percentages("row") %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(digits = 1)

mar_long <- mar_tab %>%
  filter(marital_status != "Total") %>%
  pivot_longer(cols = -marital_status, names_to = "attrition_flag", values_to = "percent")

mar_counts <- raw_data %>%
  count(marital_status, attrition_flag)

mar_plot_data <- left_join(mar_counts, mar_long, by = c("marital_status", "attrition_flag"))

ggplot(mar_plot_data, aes(x = marital_status, y = n, fill = attrition_flag)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = percent),
            position = position_dodge(width = 0.9), vjust = -0.3, size = 4) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Customer Churn by Marital Status",
    subtitle = "Based on 10,127 credit card customers",
    x = "Marital Status", y = "Number of Customers"
  ) +
  theme_minimal() +
  theme(legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```


#### dependent

```{r,message=FALSE,echo=FALSE}
dep_tab <- raw_data %>%
  tabyl(dependent_count, attrition_flag) %>%
  adorn_percentages("row") %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(digits = 1)

dep_long <- dep_tab %>%
  filter(dependent_count != "Total") %>%
  pivot_longer(cols = -dependent_count, names_to = "attrition_flag", values_to = "percent")

dep_counts <- raw_data %>%
  count(dependent_count, attrition_flag)

dep_counts <- dep_counts %>%
  mutate(dependent_count = as.character(dependent_count))


dep_plot_data <- left_join(dep_counts, dep_long, by = c("dependent_count", "attrition_flag"))

ggplot(dep_plot_data, aes(x = as.factor(dependent_count), y = n, fill = attrition_flag)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = percent),
            position = position_dodge(width = 0.9), vjust = -0.3, size = 4) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Customer Churn by Number of Dependents",
    subtitle = "Based on 10,127 credit card customers",
    x = "Number of Dependents", y = "Number of Customers"
  ) +
  theme_minimal() +
  theme(legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```







# å®¢æˆ¶æ´»èºåº¦ï¼ˆCustomer Activity Levelï¼‰


  



#### total_trans_ct (å¹´äº¤æ˜“æ¬¡æ•¸ æœƒå½±éŸ¿æµå¤±å—?)

```{r}
ggplot(raw_data, aes(x = attrition_flag, y = total_trans_ct, fill = attrition_flag)) +
  geom_boxplot(width = 0.5, alpha = 0.8, outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Distribution of Total Transactions by Customer Status",
    subtitle = "Customers who churned tend to have fewer transactions",
    x = "Customer Status",
    y = "Total Transactions (12 months)"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))
```

```{r}
library(ggplot2)
library(dplyr)

ggplot(raw_data, aes(x = total_trans_ct , fill = attrition_flag)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 30, color = "white") +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"), labels = c("Attrited", "Existing")) +
  labs(
    title = "Distribution of total_trans_ct by Attrition",
    x = "total_trans_ct",
    y = "Count",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 11)
  )

```

æµå¤±é¡§å®¢çš„å¹´äº¤æ˜“æ¬¡æ•¸æ˜é¡¯è¼ƒå°‘

ä¸­ä½æ•¸å¤§ç´„åœ¨ 40 æ¬¡å·¦å³ï¼Œè€Œéæµå¤±é¡§å®¢æ¥è¿‘ 75 æ¬¡ã€‚

æµå¤±è€…çš„äº¤æ˜“æ´»èºç¨‹åº¦é›†ä¸­ä¸”ä½

ä»–å€‘çš„è¡Œç‚ºæ¯”è¼ƒä¸€è‡´ï¼Œå¤§å¤šæ•¸é›†ä¸­åœ¨ 30â€“60 æ¬¡ä¹‹é–“ã€‚

éæµå¤±é¡§å®¢äº¤æ˜“è¡Œç‚ºè®Šç•°è¼ƒå¤§

åˆ†å¸ƒå¾€å³åï¼Œæœ‰å¾ˆå¤šé«˜é »äº¤æ˜“è€…ï¼ˆè¶…é 100 æ¬¡ä¹Ÿä¸å°‘ï¼‰ã€‚


ä½æ´»èºæ˜¯æµå¤±çš„æ˜ç¢ºé è­¦ä¿¡è™Ÿ

é¡§å®¢çš„æ´»èºåº¦ï¼ˆäº¤æ˜“æ¬¡æ•¸ï¼‰è¶Šä½ï¼Œè¶Šå¯èƒ½æµå¤±ã€‚

å¯ä»¥ç”¨äº¤æ˜“æ¬¡æ•¸ä¾†è¨­å®šå¹²é ç­–ç•¥

ä¾‹å¦‚è¨­ä¸€å€‹é–€æª»ï¼šã€Œ12 å€‹æœˆå…§äº¤æ˜“ä½æ–¼ 40 æ¬¡ã€çš„é¡§å®¢åˆ—ç‚ºé«˜é¢¨éšªåå–®ã€‚

æ¨¡å‹å»ºæ§‹ä¸Šï¼Œé€™æ˜¯ä¸€å€‹å¼·è®Šæ•¸

total_trans_ct ä¸åªæ˜¯æ•¸å€¼è®Šæ•¸ï¼Œæ›´å…·æœ‰æ˜é¡¯å€åˆ†åŠ›ï¼Œæœ‰åŠ©æ–¼æå‡æ¨¡å‹æº–ç¢ºåº¦ã€‚

####  total_ct_chng_q4_q1 (ç¬¬4å­£å°ç¬¬1å­£çš„äº¤æ˜“é »ç‡è®ŠåŒ–ç‡)



```{r}
ggplot(raw_data, aes(x = attrition_flag, y = total_ct_chng_q4_q1, fill = attrition_flag)) +
  geom_boxplot(width = 0.5, alpha = 0.8, outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Change in Transaction Count (Q4 vs Q1)",
    subtitle = "Customers with declining activity may be at risk of churn",
    x = "Customer Status",
    y = "Transaction Count Change (Q4 - Q1)"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```

```{r}
ggplot(raw_data, aes(x = total_ct_chng_q4_q1, fill = attrition_flag)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 30, color = "white") +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"), labels = c("Attrited", "Existing")) +
  labs(
    title = "Distribution of total_ct_chng_q4_q1 by Attrition",
    x = "total_ct_chng_q4_q1k",
    y = "Count",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 11)
  )

```
total_ct_chng_q4_q1ï¼ˆäº¤æ˜“æ¬¡æ•¸è®ŠåŒ–ç‡ï¼‰åœ¨ attrited å’Œ existing é¡§å®¢ä¹‹é–“
æ²’æœ‰æ˜é¡¯çš„å·®ç•°


#### total_amt_chng_q4_q1 äº¤æ˜“é‡‘é¡è®ŠåŒ–ç‡

```{r}
ggplot(raw_data, aes(x = attrition_flag, y = total_amt_chng_q4_q1, fill = attrition_flag)) +
  geom_boxplot(width = 0.5, alpha = 0.8, outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "Change in Transaction Amount (Q4 vs Q1) by Customer Status",
    subtitle = "Churned customers may reduce their spending before leaving",
    x = "Customer Status",
    y = "Q4 vs Q1 Amount Change Ratio"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```





```{r}
ggplot(raw_data, aes(x = total_amt_chng_q4_q1, fill = attrition_flag)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 30, color = "white") +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"), labels = c("Attrited", "Existing")) +
  labs(
    title = "Distribution of total_amt_chng_q4_q1 by Attrition",
    x = "total_amt_chng_q4_q1",
    y = "Count",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 11)
  )

```




total_amt_chng_q4_q1ï¼ˆäº¤æ˜“é‡‘é¡è®ŠåŒ–ç‡ï¼‰åœ¨ attrited å’Œ existing ä¹‹é–“çš„å·®ç•°ä¹Ÿå¾ˆå°ã€‚





#### total_trans_amt	å¹´åº¦äº¤æ˜“ç¸½é‡‘é¡




```{r}
ggplot(raw_data, aes(x = attrition_flag, y = total_trans_amt, fill = attrition_flag)) +
  geom_boxplot(width = 0.5, alpha = 0.8, outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "total_trans_amt",
    subtitle = "total_trans_amt",
    x = "Customer Status",
    y = "Q4 vs Q1 Amount Change Ratio"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```





```{r}
ggplot(raw_data, aes(x = total_trans_amt, fill = attrition_flag)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 30, color = "white") +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"), labels = c("Attrited", "Existing")) +
  labs(
    title = "total_trans_amt",
    x = "total_trans_amt",
    y = "Count",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 11)
  )

```

æµå¤±é¡§å®¢å¤§å¤šé›†ä¸­åœ¨ä½ç¸½äº¤æ˜“é‡‘é¡ï¼ˆtotal_trans_amtï¼‰å€é–“ï¼Œ
é«˜äº¤æ˜“é‡‘é¡å®¢æˆ¶å¹¾ä¹ä¸æµå¤±ï¼Œä»£è¡¨åƒ¹å€¼å®¢ç¾¤ç©©å®šã€‚

#### å®¢æˆ¶æ´»èºåº¦ï¼ˆCustomer Activity Levelï¼‰å°çµè«–

åœ¨æ‰€æœ‰æ´»èºåº¦è®Šæ•¸ä¸­ï¼Œ**äº¤æ˜“é‡‘é¡ç¸½é‡ï¼ˆtotal_trans_amtï¼‰èˆ‡äº¤æ˜“æ¬¡æ•¸ï¼ˆtotal_trans_ctï¼‰**å°æ–¼é æ¸¬é¡§å®¢æ˜¯å¦æœƒæµå¤±æœ€å…·å€è¾¨åŠ›ï¼Œå»ºè­°ä½œç‚ºå»ºæ¨¡èˆ‡ç­–ç•¥è¨­è¨ˆçš„ä¸»è¦è®Šæ•¸ã€‚





---

# ä¿¡ç”¨ä½¿ç”¨è¡Œç‚º Credit Usage Behavior 


#### avg_utilization_ratio	é¡§å®¢å¹³å‡ä¿¡ç”¨å¡åˆ©ç”¨ç‡ï¼ˆé¤˜é¡ï¼é¡åº¦ï¼‰ä½¿ç”¨ã€Œå¤šå°‘æ¯”ä¾‹ã€çš„é¡åº¦

```{r}
ggplot(raw_data, aes(x = attrition_flag, y = avg_utilization_ratio, fill = attrition_flag)) +
  geom_boxplot(width = 0.5, alpha = 0.8, outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "avg_utilization_ratio",
    subtitle = "avg_utilization_ratio",
    x = "Customer Status",
    y = "avg_utilization_ratio"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```



```{r}
ggplot(raw_data, aes(x = avg_utilization_ratio, fill = attrition_flag)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 30, color = "white") +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"), labels = c("Attrited", "Existing")) +
  labs(
    title = "avg_utilization_ratio",
    x = "avg_utilization_ratio",
    y = "Count",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 11)
  )

```


```{r}
library(dplyr)

raw_data <- raw_data %>%
  mutate(util_bin = cut(avg_utilization_ratio,
                        breaks = c(0, 0.1, 0.3, 0.5, 0.7, 1.0),
                        labels = c("0â€“0.1", "0.1â€“0.3", "0.3â€“0.5", "0.5â€“0.7", "0.7â€“1.0"),
                        right = TRUE))



library(janitor)

util_tab <- raw_data %>%
  tabyl(util_bin, attrition_flag) %>%
  adorn_percentages("row") %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(digits = 1)

print(util_tab)  # å¯å…ˆæª¢æŸ¥è¡¨æ ¼



library(tidyr)
library(ggplot2)

# æº–å‚™é•·æ ¼å¼è³‡æ–™ï¼ˆç§»é™¤ Total rowï¼‰
util_long <- util_tab %>%
  filter(util_bin != "Total") %>%
  pivot_longer(cols = -util_bin,
               names_to = "attrition_flag",
               values_to = "percent")

# ç¹ªè£½åˆ†çµ„æ¢åœ–
ggplot(util_long, aes(x = util_bin, y = percent, fill = attrition_flag)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = percent),
            position = position_dodge(width = 0.9),
            vjust = -0.3, size = 4) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"),
                    labels = c("Attrited", "Existing")) +
  labs(
    title = "Churn Rate by Credit Utilization Level",
    subtitle = "Grouped by average utilization ratio",
    x = "Utilization Ratio (Binned)",
    y = "Percentage (%)",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))


```


é¡§å®¢å¹³å‡ä¿¡ç”¨å¡åˆ©ç”¨ç‡ï¼ˆé¤˜é¡ï¼é¡åº¦ï¼‰

åˆ©ç”¨ç‡é«˜ï¼ˆâ†’ æ¥è¿‘ 1ï¼‰	                  åˆ©ç”¨ç‡ä½ï¼ˆâ†’ æ¥è¿‘ 0ï¼‰
å¹¾ä¹æŠŠä¿¡ç”¨é¡åº¦ç”¨æ»¿äº†ï¼ˆå¯èƒ½æœ‰è³‡é‡‘å£“åŠ›ï¼‰	ä½¿ç”¨é¡åº¦ç›¸å°ä¿å®ˆï¼ˆè³‡é‡‘è¼ƒç©©å®šï¼‰
è²¡å‹™é¢¨éšªé«˜ â†’ å¯èƒ½å°‡é—œå¸³æˆ–æµå¤±	          å¿ èª æˆ–ä¿å®ˆå‹ä½¿ç”¨è€…
å¯èƒ½ä»£è¡¨å‚¾å‘æå‰é—œå¡é‚„æ¬¾ã€é¢¨éšªé«˜	      ä½é¢¨éšªæ ¸å¿ƒå®¢ç¾¤


å› ç‚ºåœ¨è¨±å¤šä¿¡è²¸æˆ–ä¿¡ç”¨é¢¨éšªé ˜åŸŸï¼Œäººå€‘æœƒç›´è¦ºåœ°èªç‚ºï¼š

ã€Œä¿¡ç”¨å¡ä½¿ç”¨ç‡é«˜ = è²¡å‹™å£“åŠ›å¤§ = æ¯”è¼ƒå®¹æ˜“é—œå¸³æˆ–æµå¤±ã€

ä½†ä½ å‰›å‰›ç•«çš„åœ–å»é¡¯ç¤ºï¼š

çœŸæ­£æµå¤±çš„å®¢æˆ¶ï¼Œåè€Œæ˜¯é‚£äº›ã€Œä½ä¿¡ç”¨å¡åˆ©ç”¨ç‡ã€çš„å®¢æˆ¶ã€‚

é€™å°±æ˜¯æ‰€è¬‚çš„ã€Œåç›´è¦ºï¼ˆcounterintuitiveï¼‰ã€

McKinseyï¼ˆ2020ï¼‰ï¼šæŒ‡å‡ºé«˜é »äº¤æ˜“å®¢æˆ¶çš„ç•™å­˜ç‡æ¯”ä½ä½¿ç”¨è€…é«˜ 40â€“60%ã€‚

éŠ€è¡Œå®¢æˆ¶çµ‚ç”Ÿåƒ¹å€¼æ¨¡å‹ï¼ˆCLVï¼‰ï¼šé«˜ä½¿ç”¨è€… â‰ˆ é«˜ CLV â†’ retention investment priorityã€‚

**è¡Œç‚ºå¼åˆ†ç¾¤ï¼ˆBehavioral Segmentationï¼‰**å¸¸ç”¨ utilization ratio ç•¶ä½œ engagement proxy





avg_utilization_ratioï¼ˆå¹³å‡ä¿¡ç”¨å¡åˆ©ç”¨ç‡ï¼‰é«˜çš„å®¢æˆ¶åè€Œä¸å®¹æ˜“æµå¤±ï¼Œ
Attrited å®¢æˆ¶å¤§å¤šé›†ä¸­åœ¨ä½åˆ©ç”¨ç‡å€åŸŸã€‚

åœ¨éŠ€è¡Œæ¥­å±¬æ–¼å¸¸æ…‹ï¼Œç¬¦åˆå¯¦å‹™ç¶“é©—èˆ‡æ—¢æœ‰ç ”ç©¶


#### credit_limit æ ¸å®šä¿¡ç”¨é¡åº¦



```{r}
ggplot(raw_data, aes(x = attrition_flag, y = credit_limit, fill = attrition_flag)) +
  geom_boxplot(width = 0.5, alpha = 0.8, outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "credit_limit",
    subtitle = "credit_limit",
    x = "Customer Status",
    y = "avg_utilization_ratio"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```



```{r}
ggplot(raw_data, aes(x = credit_limit, fill = attrition_flag)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 30, color = "white") +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"), labels = c("Attrited", "Existing")) +
  labs(
    title = "credit_limit",
    x = "credit_limit",
    y = "Count",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 11)
  )

```


```{r}
library(dplyr)

raw_data <- raw_data %>%
  mutate(limit_bin = cut(credit_limit,
                         breaks = c(0, 5000, 10000, 20000, 30000, Inf),
                         labels = c("â‰¤5K", "5Kâ€“10K", "10Kâ€“20K", "20Kâ€“30K", ">30K"),
                         right = TRUE))


library(janitor)

limit_tab <- raw_data %>%
  tabyl(limit_bin, attrition_flag) %>%
  adorn_percentages("row") %>%
  adorn_totals("row") %>%
  adorn_pct_formatting(digits = 1)

print(limit_tab)  # å¯å…ˆæª¢æŸ¥è¡¨æ ¼

library(tidyr)
library(ggplot2)

# ç§»é™¤ç¸½è¨ˆåˆ—
limit_long <- limit_tab %>%
  filter(limit_bin != "Total") %>%
  pivot_longer(cols = -limit_bin,
               names_to = "attrition_flag",
               values_to = "percent")

# ç¹ªè£½åˆ†ç®± Churn Rate åœ–
ggplot(limit_long, aes(x = limit_bin, y = percent, fill = attrition_flag)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = percent),
            position = position_dodge(width = 0.9), vjust = -0.3, size = 4) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"),
                    labels = c("Attrited", "Existing")) +
  labs(
    title = "Churn Rate by Credit Limit Bracket",
    subtitle = "Grouped by approved credit limit",
    x = "Credit Limit Range",
    y = "Percentage (%)",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```




ä¿¡ç”¨é¡åº¦åœ¨é€™ä»½è³‡æ–™ä¸­ä¸æ˜¯ä¸€å€‹æœ‰æ˜é¡¯å€è¾¨åŠ›çš„è®Šæ•¸ï¼Œæµå¤±å®¢æˆ¶éä½ˆå„é¡åº¦å€é–“ï¼Œæ²’æœ‰ç‰¹å®šã€Œé«˜é¡ç•™å­˜ã€ä½é¡æµå¤±ã€çš„è¶¨å‹¢ã€‚é€™å€‹è®Šæ•¸å¯ä»¥ä¿ç•™åœ¨æ¨¡å‹ä¸­è§€å¯Ÿäº¤äº’æ•ˆæ‡‰ï¼Œä½†åœ¨å–®ä¸€è§£é‡‹ä¸Šæ„ç¾©æœ‰é™


ä½é¡åº¦å®¢æˆ¶æ¯”è¼ƒå¤šæµå¤±ï¼Œé€™åˆ°åº•ç®—ä¸ç®—ä¸€å€‹å¤ å¼·çš„ç™¼ç¾ï¼Ÿ



é€™å€‹ç™¼ç¾æœ‰å¯èƒ½æ˜¯ã€Œçµæ§‹æ€§åˆ†å¸ƒã€ï¼Œè€Œéã€Œæµå¤±å‚¾å‘ã€ã€‚
âœ” æ˜¯çš„ï¼Œä½é¡åº¦å€é–“çš„ç¢ºæœ‰è¼ƒå¤šæµå¤±è€…ï¼Œä½†é€™æœ‰å…©ç¨®å¯èƒ½è§£é‡‹ï¼š
é€™å€æœ¬ä¾†å°±äººæœ€å¤š â†’ çµ•å°æ•¸é«˜å¾ˆæ­£å¸¸
â†’ ä¹Ÿå°±æ˜¯æ¯é«”åŸºæ•¸å¤§ï¼Œä¸ä»£è¡¨é¢¨éšªé«˜

æ²’æœ‰æ˜é¡¯ã€Œé¡åº¦è¶Šä½ â†’ æµå¤±ç‡è¶Šé«˜ã€çš„è¶¨å‹¢
â†’ å¦‚æœè¦ç•¶ä½œå¼·ç™¼ç¾ï¼Œæ‡‰è©²åœ¨åˆ†ç®±å¾Œè§€å¯Ÿåˆ°ã€Œä½é¡åº¦å€çš„æµå¤±æ¯”ä¾‹ï¼ˆç™¾åˆ†æ¯”ï¼‰ç‰¹åˆ¥é«˜



âœ… è§€å¯Ÿ 1ï¼šæ•´é«”è®ŠåŒ–è¶¨å‹¢å°
æµå¤±ç‡åœ¨ä¸åŒé¡åº¦å€é–“é–“ç•¥æœ‰èµ·ä¼ï¼Œä½†æ•´é«”å·®ç•°å¹…åº¦ä¸å¤§ï¼ˆåœ¨ 12.7%ï½17.3% é–“æµ®å‹•ï¼‰ã€‚

ä¸¦æ²’æœ‰å‘ˆç¾ã€Œä¿¡ç”¨é¡åº¦è¶Šä½ â†’ æµå¤±ç‡è¶Šé«˜ã€çš„å–®èª¿éå¢è¶¨å‹¢ã€‚

âœ… è§€å¯Ÿ 2ï¼šæ¥µç«¯é«˜èˆ‡æ¥µç«¯ä½éƒ½æœ‰ç•¥é«˜æµå¤±
â‰¤5K å’Œ >30K çš„å€é–“æµå¤±ç‡åé«˜ï¼ˆ17.3%ã€16.2%ï¼‰ã€‚

ä½†ä¸­é–“å€é–“ï¼ˆ10Kâ€“30Kï¼‰å‰‡æœ‰è¼ƒä½æµå¤±ç‡ï¼ˆç´„ 12.7%â€“14.4%ï¼‰ã€‚


#### avg_open_to_buy å¯å‹•ç”¨é¡åº¦ é‚„èƒ½åˆ·å¤šå°‘




```{r}
ggplot(raw_data, aes(x = attrition_flag, y = avg_open_to_buy, fill = attrition_flag)) +
  geom_boxplot(width = 0.5, alpha = 0.8, outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "avg_open_to_buy",
    subtitle = "avg_open_to_buy",
    x = "Customer Status",
    y = "avg_utilization_ratio"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```



```{r}
ggplot(raw_data, aes(x = avg_open_to_buy, fill = attrition_flag)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 30, color = "white") +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"), labels = c("Attrited", "Existing")) +
  labs(
    title = "avg_open_to_buy",
    x = "avg_open_to_buy",
    y = "Count",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 11)
  )

```


å’Œ avg_utilization_ratio ç›¸æ¯”ï¼Œavg_open_to_buy è¾¨åˆ¥åŠ›ç•¥ä½ã€‚

ä½†ä»èƒ½æä¾›ä¸€å€‹è£œå……è§’åº¦ï¼šAttrited å®¢æˆ¶çš„å¯ç”¨ç©ºé–“ä¹Ÿåå°‘ï¼Œä½†ä¸æ˜¯æœ€æ˜é¡¯çš„åˆ†ç•Œã€‚

å¯¦å‹™ä¸Šï¼Œé€™å€‹è®Šæ•¸å¯èƒ½é©åˆç”¨æ–¼æ¨¡å‹ä¸­èˆ‡å…¶ä»–ä¿¡ç”¨é¡åº¦è¡Œç‚ºè®Šæ•¸ï¼ˆå¦‚ credit_limitã€utilizationï¼‰å…±åŒè§£é‡‹ï¼Œè€Œéå–®ç¨ç”¨ä¾†é æ¸¬ã€‚

#### total_revolving_bal å®¢æˆ¶çš„ä¿¡ç”¨å¡æœªç¹³é¤˜é¡


```{r}
ggplot(raw_data, aes(x = attrition_flag, y = total_revolving_bal, fill = attrition_flag)) +
  geom_boxplot(width = 0.5, alpha = 0.8, outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "total_revolving_bal",
    subtitle = "total_revolving_bal",
    x = "Customer Status",
    y = "avg_utilization_ratio"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

```



```{r}
ggplot(raw_data, aes(x = total_revolving_bal, fill = attrition_flag)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 30, color = "white") +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"), labels = c("Attrited", "Existing")) +
  labs(
    title = "total_revolving_bal",
    x = "total_revolving_bal",
    y = "Count",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 11)
  )

```


total_revolving_bal çµ•å°å€¼å¾—ç´å…¥æ¨¡å‹ï¼Œå› ç‚ºå®ƒæ˜é¡¯æ­ç¤ºæµå¤±å®¢æˆ¶æœ‰ã€Œä¸ç”¨å¡ã€çš„è¡Œç‚ºï¼Œå’Œ total_trans_ct & utilization_ratio ä¸€è‡´ã€‚





#### ä¿¡ç”¨ä½¿ç”¨è¡Œç‚º Credit Usage Behavior å°çµè«–

| æŒ‡æ¨™ | è³‡è¨Šåƒ¹å€¼ | è§£è®€é‡é» |
|------|------------|----------|
| `total_revolving_bal` | âœ… é«˜ | Attrited å®¢æˆ¶å¤šç‚ºã€Œæ²’åœ¨ç”¨ã€æ²’æ¬ éŒ¢ã€ï¼Œæ˜¯éæ´»èºè·¡è±¡ |
| `avg_utilization_ratio` | âœ… é«˜ | æ¨™æº–åŒ–ä½¿ç”¨ç‡ä½ï¼Œæ›´æ¸…æ¥šé¡¯ç¤ºã€Œä¸ç”¨å¡ã€ |
| `avg_open_to_buy` | âš ï¸ ä¸­ | å› ç‚ºé¡åº¦ä¸åŒï¼Œè§£é‡‹ç•¥æ¨¡ç³Š |
| `credit_limit` | âš ï¸ ä¸­ | çµæ§‹è®Šæ•¸ï¼Œä¸ç›´æ¥åæ˜ è¡Œç‚º |



# Account Relationship Strength





#### months_on_bookï¼ˆå¸³æˆ¶æŒæœ‰æœˆæ•¸ï¼‰

```{r}
# Boxplot
ggplot(raw_data, aes(x = attrition_flag, y = months_on_book, fill = attrition_flag)) +
  geom_boxplot(width = 0.5, alpha = 0.8, outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "months_on_book",
    subtitle = "Duration of Customer Relationship (in months)",
    x = "Customer Status",
    y = "Months on Book"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

# Histogram
ggplot(raw_data, aes(x = months_on_book, fill = attrition_flag)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 30, color = "white") +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"), labels = c("Attrited", "Existing")) +
  labs(
    title = "months_on_book",
    x = "Months on Book",
    y = "Count",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 11)
  )

```



#### total_relationship_count

```{r}
# Boxplot
ggplot(raw_data, aes(x = attrition_flag, y = total_relationship_count, fill = attrition_flag)) +
  geom_boxplot(width = 0.5, alpha = 0.8, outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "total_relationship_count",
    subtitle = "Number of Bank Products Held by Customer",
    x = "Customer Status",
    y = "Relationship Count"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

# Histogram
ggplot(raw_data, aes(x = total_relationship_count, fill = attrition_flag)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 6, color = "white") +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"), labels = c("Attrited", "Existing")) +
  labs(
    title = "total_relationship_count",
    x = "Number of Bank Products",
    y = "Count",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 11)
  )





```





#### months_inactive_12_mon

```{r}
# Boxplot
ggplot(raw_data, aes(x = attrition_flag, y = months_inactive_12_mon, fill = attrition_flag)) +
  geom_boxplot(width = 0.5, alpha = 0.8, outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "months_inactive_12_mon",
    subtitle = "Inactive Months in the Last Year",
    x = "Customer Status",
    y = "Inactive Months"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

# Histogram
ggplot(raw_data, aes(x = months_inactive_12_mon, fill = attrition_flag)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 6, color = "white") +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"), labels = c("Attrited", "Existing")) +
  labs(
    title = "months_inactive_12_mon",
    x = "Inactive Months (past 12)",
    y = "Count",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 11)
  )

```





#### contacts_count_12_mon

```{r}
# Boxplot
ggplot(raw_data, aes(x = attrition_flag, y = contacts_count_12_mon, fill = attrition_flag)) +
  geom_boxplot(width = 0.5, alpha = 0.8, outlier.shape = 16, outlier.size = 2) +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed")) +
  labs(
    title = "contacts_count_12_mon",
    subtitle = "Customer Service Contacts in Last 12 Months",
    x = "Customer Status",
    y = "Contact Count"
  ) +
  theme_minimal() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

# Histogram
ggplot(raw_data, aes(x = contacts_count_12_mon, fill = attrition_flag)) +
  geom_histogram(position = "identity", alpha = 0.6, bins = 6, color = "white") +
  scale_fill_manual(values = c("#004c6d", "#a7c6ed"), labels = c("Attrited", "Existing")) +
  labs(
    title = "contacts_count_12_mon",
    x = "Number of Contacts (past 12)",
    y = "Count",
    fill = "Customer Status"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.title = element_text(size = 11)
  )

```

ğŸ”¹ 1. months_on_book
ä»£è¡¨æ„ç¾©ï¼šè¡¨ç¤ºå®¢æˆ¶èˆ‡éŠ€è¡Œç¶­æŒé—œä¿‚çš„æ™‚é–“ï¼ˆè¶Šé•·ä»£è¡¨å¿ èª åº¦å¯èƒ½è¶Šé«˜ï¼‰
è§€å¯Ÿé‡é»ï¼š

æ­¤è®Šæ•¸åœ¨å…©ç¾¤ä¹‹é–“å¹¾ä¹å°ç¨±ï¼Œèªªæ˜ã€Œé—œä¿‚æŒçºŒæ™‚é–“ã€å¯èƒ½ä¸æ˜¯ä¸»è¦çš„æµå¤±é©…å‹•å› å­ã€‚

æŸå€‹æœˆä»½ï¼ˆå¦‚ 36 å€‹æœˆï¼‰æ˜é¡¯å‡ºç¾å°–å³° â†’ æ‡‰è€ƒæ…®æ˜¯å¦æœ‰ã€Œåˆç´„é€±æœŸã€æˆ–ã€Œç³»çµ±æ€§æ›´æ–°ã€å°è‡´é€™å€‹æœˆæ•¸ç‰¹åˆ¥å¤šã€‚

ğŸ”¹ 2. total_relationship_count
ä»£è¡¨æ„ç¾©ï¼šä¸€ä½å®¢æˆ¶åœ¨è©²è¡Œæ“æœ‰å¤šå°‘é‡‘èç”¢å“ï¼Œé€šå¸¸ä»£è¡¨é»è‘—åº¦èˆ‡åƒ¹å€¼è²¢ç»
è§€å¯Ÿé‡é»ï¼š

æ“æœ‰è¼ƒå¤šç”¢å“çš„å®¢æˆ¶ï¼Œæµå¤±ç‡ç›¸å°è¼ƒä½ã€‚

æµå¤±å®¢æˆ¶é›†ä¸­åœ¨ 1â€“3 å€‹ç”¢å“å€é–“ï¼Œæš—ç¤ºã€Œé—œä¿‚æ·ºè–„ã€è€…æ›´æ˜“æµå¤±ã€‚

ğŸ”¹ 3. months_inactive_12_mon
ä»£è¡¨æ„ç¾©ï¼šéå»ä¸€å¹´ä¸­ï¼Œæœ‰å¤šå°‘å€‹æœˆæ²’æœ‰ä½¿ç”¨éå¸³æˆ¶ã€‚é€™æ˜¯ä¸€å€‹å…ˆè¡ŒæŒ‡æ¨™ï¼ˆleading indicatorï¼‰ã€‚
è§€å¯Ÿé‡é»ï¼š

æµå¤±å®¢æˆ¶åœ¨ 3â€“6 å€‹æœˆç„¡æ´»å‹•çš„æ¯”ä¾‹æ˜é¡¯åé«˜ã€‚

å¯ç”¨ä¾†è¨­è¨ˆé æ¸¬æ¨¡å‹çš„ early warning signalã€‚

ğŸ”¹ 4. contacts_count_12_mon
ä»£è¡¨æ„ç¾©ï¼šéå»ä¸€å¹´è¯çµ¡å®¢æœçš„æ¬¡æ•¸ã€‚å¯èƒ½æ˜¯æŠ±æ€¨ã€å•é¡Œã€ç”³è¨´ç­‰ã€‚
è§€å¯Ÿé‡é»ï¼š

æµå¤±å®¢æˆ¶çš„è¯çµ¡é »ç‡ç•¥é«˜ï¼ˆç‰¹åˆ¥æ˜¯ 4â€“6 æ¬¡ï¼‰ã€‚

èˆ‡æœå‹™æ»¿æ„åº¦æˆ–å•é¡Œè™•ç†æ•ˆç‡æœ‰é—œ â†’ å¯ä½œç‚ºé–“æ¥æœå‹™å“è³ªæŒ‡æ¨™ã€‚


#### Account Relationship Strength å°çµ

| è®Šæ•¸ | é‡è¦æ€§åˆ¤æ–· | åŸå›  |
|------|--------------|------|
| `months_on_book` | ä½ | æ²’æœ‰æ˜é¡¯å·®ç•° |
| `total_relationship_count` | ä¸­ç­‰ | æµå¤±ç‡èˆ‡ç”¢å“æ•¸é‡æ˜é¡¯å‘ˆç¾è² ç›¸é—œ |
| `months_inactive_12_mon` | é«˜ | æ´»èºåº¦ä¸‹é™æ˜¯æµå¤±çš„é‡è¦æŒ‡æ¨™ |
| `contacts_count_12_mon` | ä¸­ç­‰åé«˜ | å®¢æœè¯ç¹«æ¬¡æ•¸å¯èƒ½åæ˜ ä¸æ»¿æ„ï¼Œèˆ‡æµå¤±æœ‰æ½›åœ¨é—œè¯ |

# radar plot

```{r}
library(dplyr)
library(fmsb)

# Step 1: æ•´ç†è³‡æ–™ï¼ˆèˆ‡ä¹‹å‰ç›¸åŒï¼‰
radar_df <- raw_data %>%
  mutate(
    high_trans = if_else(total_trans_ct > median(total_trans_ct, na.rm = TRUE), 1, 0),
    amt_change_high = if_else(total_amt_chng_q4_q1 > 1.5, 1, 0),
    high_util = if_else(avg_utilization_ratio > 0.3, 1, 0),
    high_revolve_bal = if_else(total_revolving_bal > 1000, 1, 0),
    frequent_contact = if_else(contacts_count_12_mon > 2, 1, 0)
  ) %>%
  select(attrition_flag, high_trans, amt_change_high, high_util, high_revolve_bal, frequent_contact)

radar_data <- radar_df %>%
  group_by(attrition_flag) %>%
  summarise(across(everything(), ~ mean(.x, na.rm = TRUE))) %>%
  as.data.frame()

rownames(radar_data) <- radar_data$attrition_flag
radar_data <- radar_data[, -1]
radar_data <- rbind(rep(1, ncol(radar_data)), rep(0, ncol(radar_data)), radar_data)

# Step 2: è¨­å®šç¾åŒ–æ¨£å¼
colors_border <- c(rgb(0.2, 0.5, 0.5, 0.9), rgb(0.8, 0.2, 0.5, 0.9))
colors_fill <- c(rgb(0.2, 0.5, 0.5, 0.4), rgb(0.8, 0.2, 0.5, 0.4))

# Step 3: ç•«åœ–
radarchart(radar_data,
           axistype = 1,
           pcol = colors_border,
           pfcol = colors_fill,
           plwd = 4,
           plty = 1,
           cglcol = "grey", 
           cglty = 1, 
           axislabcol = "grey", 
           cglwd = 0.8,
           vlcex = 1.1
)

# Step 4: åœ–ä¾‹
legend(x = 0.7, y = 1,
       legend = c("Existing Customer", "Attrited Customer"),
       bty = "n", pch = 20, col = colors_fill,
       text.col = "grey20", cex = 1.2, pt.cex = 3)


```


```{r}
library(dplyr)
library(fmsb)

# Step 1: æº–å‚™è³‡æ–™èˆ‡äºŒå…ƒè®Šæ•¸
radar_df <- raw_data %>%
  mutate(
    high_trans = if_else(total_trans_ct > median(total_trans_ct, na.rm = TRUE), 1, 0),
    amt_change_high = if_else(total_amt_chng_q4_q1 > 1.5, 1, 0),
    high_util = if_else(avg_utilization_ratio > 0.3, 1, 0),
    high_revolve_bal = if_else(total_revolving_bal > 1000, 1, 0),
    frequent_contact = if_else(contacts_count_12_mon > 2, 1, 0)
  ) %>%
  select(attrition_flag, high_trans, amt_change_high, high_util, high_revolve_bal, frequent_contact)

# Step 2: è¨ˆç®—å¹³å‡å€¼
radar_data <- radar_df %>%
  group_by(attrition_flag) %>%
  summarise(across(everything(), ~ mean(.x, na.rm = TRUE))) %>%
  as.data.frame()

# Step 3: å»ºç«‹ radar è³‡æ–™
rownames(radar_data) <- radar_data$attrition_flag
radar_data <- radar_data[, -1]
radar_data <- rbind(rep(1, ncol(radar_data)), rep(0, ncol(radar_data)), radar_data)

# Step 4: é«˜è³ªæ„Ÿé›·é”åœ–
colors_border <- c("#1f77b4", "#d62728")      # ç·šæ¢é¡è‰²
colors_fill   <- c("#1f77b4AA", "#d62728AA")  # åŠé€æ˜å¡«è‰²

radarchart(radar_data,
           axistype = 1,
           pcol = colors_border,
           pfcol = colors_fill,
           plwd = 2,
           plty = 1,
           cglcol = "grey",
           cglty = 1,
           cglwd = 0.8,
           axislabcol = "black",
           vlcex = 1.1,
           title = "Radar Chart: Customer Behavioral Profile")

legend(x = "topright",
       legend = c("Existing Customer", "Attrited Customer"),
       col = colors_border,
       lty = 1,
       lwd = 2,
       bty = "n")

```


```{r}
library(dplyr)
library(ggplot2)

# Step 1: å»ºç«‹åˆ†é¡èˆ‡äº”å€‹æŒ‡æ¨™ï¼ˆèˆ‡ä¹‹å‰ç›¸åŒï¼‰
lollipop_data <- raw_data %>%
  mutate(
    high_trans = if_else(total_trans_ct > median(total_trans_ct, na.rm = TRUE), 1, 0),
    amt_change_high = if_else(total_amt_chng_q4_q1 > 1.5, 1, 0),
    high_util = if_else(avg_utilization_ratio > 0.3, 1, 0),
    high_revolve_bal = if_else(total_revolving_bal > 1000, 1, 0),
    frequent_contact = if_else(contacts_count_12_mon > 2, 1, 0)
  ) %>%
  select(attrition_flag, high_trans, amt_change_high, high_util, high_revolve_bal, frequent_contact)

# Step 2: è¨ˆç®—å…©çµ„ç¾¤é«”çš„å¹³å‡æ¯”ä¾‹
lollipop_summary <- lollipop_data %>%
  group_by(attrition_flag) %>%
  summarise(across(everything(), ~ mean(.x, na.rm = TRUE))) %>%
  pivot_longer(cols = -attrition_flag, names_to = "feature", values_to = "value") %>%
  pivot_wider(names_from = attrition_flag, values_from = value) %>%
  rename(existing = `Existing Customer`, attrited = `Attrited Customer`)

# Step 3: ç¹ªè£½ Lollipop Plot
ggplot(lollipop_summary) +
  geom_segment(aes(x = feature, xend = feature, y = existing, yend = attrited), color = "grey") +
  geom_point(aes(x = feature, y = existing), color = "#1f77b4", size = 4) +
  geom_point(aes(x = feature, y = attrited), color = "#d62728", size = 4, alpha = 0.8) +
  coord_flip() +
  labs(
    title = "Customer Behavior Comparison: Existing vs Attrited",
    y = "Proportion (binary feature = 1)",
    x = NULL
  ) +
  theme_minimal() +
  theme(
    panel.grid.minor.y = element_blank(),
    panel.grid.major.y = element_blank(),
    axis.text = element_text(size = 12),
    plot.title = element_text(size = 15, face = "bold")
  )

```



```{r}
skim(raw_data)
names(train_data2)  # çœ‹ç›®å‰è³‡æ–™é›†æ¬„ä½åä¸­æœ‰æ²’æœ‰ "util_bin"

```

```{r,message=FALSE}
raw_data<-read_csv(here("Data","bank_churners.csv")) %>% 
  clean_names()

```



# Data split

```{r}
set.seed(47969938)
data_split2<- initial_split(raw_data, prop = 0.8, strata = attrition_flag)
train_data2<- training(data_split2)
test_data2 <- testing(data_split2)
# Cross-validation folds
cross_validation_folds2 <- vfold_cv(train_data2, v = 10, strata = attrition_flag)

```



# Logistic base model - clean version

```{r}
# Define model
base_logistic_spec2 <- logistic_reg() %>%
  set_engine("glm") %>%
  set_mode("classification")

# Define recipe ---------------------------------------------------------------
logistic_recipe2 <- recipe(attrition_flag ~ ., data = train_data2) |> 
  step_other(all_nominal_predictors(), threshold = 0.05) |>  # 1. åˆä½µå°çœ¾é¡åˆ¥
  step_zv(all_predictors()) |>                               # 2. ç§»é™¤å¸¸æ•¸æˆ–é›¶è®Šç•°è®Šæ•¸
  step_corr(all_numeric_predictors(), threshold = 0.7) |>    # 3. å‰ƒæ‰é«˜ç›¸é—œæ•¸å€¼è®Šæ•¸
  step_dummy(all_nominal_predictors()) |>                    # 4. æŠŠé¡åˆ¥è½‰æˆ 0/1 dummy
  step_normalize(all_numeric_predictors())                   # 5. æ¨™æº–åŒ–æ•¸å€¼è®Šæ•¸


# Create workflow -------------------------------------------------------------
base_logistic_wf2 <- workflow() |> 
  add_model(base_logistic_spec2) |> 
  add_recipe(logistic_recipe2)

# Cross-validation: fit_resamples ---------------------------------------------
base_logistic_cv2 <- fit_resamples(
  base_logistic_wf2,
  resamples = cross_validation_folds2,
  metrics = metric_set(roc_auc, accuracy)
)

# Evaluation on cross-validation folds ----------------------------------------
collect_metrics(base_logistic_cv2)

# Last fit: ç”¨ train_data2 fitï¼Œpredict test_data2
final_base_fit2 <- last_fit(
  base_logistic_wf2,
  split = data_split2,
  metrics = metric_set( # ç›´æ¥åœ¨æ­¤æ“´å……æŒ‡æ¨™
    roc_auc, 
    accuracy,
    recall,     # æ–°å¢
    precision,  # æ–°å¢
    f_meas      # æ–°å¢
))

# Collect performance on test set
collect_metrics(final_base_fit2)



```


```{r}
# 1. prep recipe
logistic_recipe2_prep <- logistic_recipe2 |> prep()

# 2. checkå‰ƒé™¤çš„è®Šæ•¸
tidy(logistic_recipe2_prep, number = 3) |> 
  filter(terms != "(Intercept)")

```
```{r}
tidy(logistic_recipe2_prep)

tidy(logistic_recipe2_prep, number = 4) |> 
  filter(terms != "(Intercept)")
```


```{r}
# å…ˆè¼‰å¥½å¿…è¦çš„å¥—ä»¶
library(vip)

# ç•« Variable Importance Plot
final_base_fit2 %>%
  extract_fit_parsnip() %>%
  vip(num_features = 20)  # åªåˆ—å‡ºå‰20é‡è¦çš„è®Šæ•¸

```

# é¡åˆ¥åˆ†å¸ƒ (æµå¤±æ¯”ä¾‹)

```{r}
table(train_data2$attrition_flag)
prop.table(table(train_data2$attrition_flag))
```




# æ··æ·†çŸ©é™£

```{r}
final_base_fit2 %>%
  collect_predictions() %>%
  conf_mat(truth = attrition_flag, estimate = .pred_class)
```















# Ridge Logistic Regression (mixture = 0) - clean version


```{r}
# Ridge Logistic Regression (mixture = 0) - clean version

# Define model
ridge_spec2 <- logistic_reg(
  penalty = tune(),   # penaltyè¦tune
  mixture = 0         # mixture = 0 = Ridge
) %>%
  set_engine("glmnet") %>%
  set_mode("classification")

# Create workflow
ridge_wf2 <- workflow() %>%
  add_model(ridge_spec2) %>%
  add_recipe(logistic_recipe2)   # <--- ç”¨ä¹¾æ·¨ç‰ˆrecipe2

# Define tuning grid
ridge_grid2 <- grid_regular(
  penalty(range = c(-4, 0)),
  levels = 30
)

# Tuning
ridge_tune2 <- tune_grid(
  ridge_wf2,
  resamples = cross_validation_folds2,  # <--- ç”¨ä¹¾æ·¨ç‰ˆfolds2
  grid = ridge_grid2,
  metrics = metric_set(roc_auc, accuracy)
)

# Select best model
best_ridge2 <- select_best(ridge_tune2, metric = "roc_auc")

# Finalize workflow
final_ridge_wf2 <- finalize_workflow(ridge_wf2, best_ridge2)

# Last fit
final_ridge_fit2 <- last_fit(
  final_ridge_wf2,
  split = data_split2,   # <--- ç”¨ä¹¾æ·¨ç‰ˆsplit2
  metrics = metric_set( # ç›´æ¥åœ¨æ­¤æ“´å……æŒ‡æ¨™
    roc_auc, 
    accuracy,
    recall,     # æ–°å¢
    precision,  # æ–°å¢
    f_meas      # æ–°å¢
))

# Collect metrics
collect_metrics(final_ridge_fit2)

```



# Lasso Logistic Regression (mixture = 1) - clean version


```{r}
# Lasso Logistic Regression (mixture = 1) - clean version

# Define model
lasso_spec2 <- logistic_reg(
  penalty = tune(),   # penaltyè¦tune
  mixture = 1         # mixture = 1 = Lasso
) %>%
  set_engine("glmnet") %>%
  set_mode("classification")

# Create workflow
lasso_wf2 <- workflow() %>%
  add_model(lasso_spec2) %>%
  add_recipe(logistic_recipe2)  # ç”¨ä¹¾æ·¨ç‰ˆrecipe2

# Define tuning grid
lasso_grid2 <- grid_regular(
  penalty(range = c(-4, 0)),
  levels = 30
)

# Tuning
lasso_tune2 <- tune_grid(
  lasso_wf2,
  resamples = cross_validation_folds2,  # ç”¨ä¹¾æ·¨ç‰ˆ folds2
  grid = lasso_grid2,
  metrics = metric_set(roc_auc, accuracy)
)

# Select best model
best_lasso2 <- select_best(lasso_tune2, metric = "roc_auc")

# Finalize workflow
final_lasso_wf2 <- finalize_workflow(lasso_wf2, best_lasso2)

# Last fit
final_lasso_fit2 <- last_fit(
  final_lasso_wf2,
  split = data_split2,   # ç”¨ä¹¾æ·¨ç‰ˆ split2
  metrics = metric_set( # ç›´æ¥åœ¨æ­¤æ“´å……æŒ‡æ¨™
    roc_auc, 
    accuracy,
    recall,     # æ–°å¢
    precision,  # æ–°å¢
    f_meas      # æ–°å¢
))

# Collect metrics
collect_metrics(final_lasso_fit2)

```




# Elastic Net Logistic Regression - clean version

```{r}
# Elastic Net Logistic Regression - clean version

# Define model
elastic_spec2 <- logistic_reg(
  penalty = tune(),
  mixture = tune()    # Elastic Netè¦tune mixture
) %>%
  set_engine("glmnet") %>%
  set_mode("classification")

# Create workflow
elastic_wf2 <- workflow() %>%
  add_model(elastic_spec2) %>%
  add_recipe(logistic_recipe2)  # ç”¨ä¹¾æ·¨ç‰ˆrecipe2

# Define tuning grid
elastic_grid2 <- grid_regular(
  penalty(range = c(-4, 0)),
  mixture(range = c(0, 1)),
  levels = c(20, 5)             # penaltyå–20é»ï¼Œmixtureå–5é»
)

# Tuning
elastic_tune2 <- tune_grid(
  elastic_wf2,
  resamples = cross_validation_folds2,  # ç”¨ä¹¾æ·¨ç‰ˆ folds2
  grid = elastic_grid2,
  metrics = metric_set(roc_auc, accuracy)
)

# Select best model
best_elastic2 <- select_best(elastic_tune2, metric = "roc_auc")

# Finalize workflow
final_elastic_wf2 <- finalize_workflow(elastic_wf2, best_elastic2)

# Last fit
final_elastic_fit2 <- last_fit(
  final_elastic_wf2,
  split = data_split2,  # ç”¨ä¹¾æ·¨ç‰ˆ split2
  metrics = metric_set( # ç›´æ¥åœ¨æ­¤æ“´å……æŒ‡æ¨™
    roc_auc, 
    accuracy,
    recall,     # æ–°å¢
    precision,  # æ–°å¢
    f_meas      # æ–°å¢
))

# Collect metrics
collect_metrics(final_elastic_fit2)

```



# KNN - clean version

```{r}
# KNN - clean version

# 1.1 Define KNN model
knn_spec2 <- nearest_neighbor(
  neighbors = tune()
) %>%
  set_engine("kknn") %>%
  set_mode("classification")

# 1.2 Define Recipeï¼ˆè¨˜å¾—è¦normalizeï¼‰
knn_recipe2 <- recipe(attrition_flag ~ ., data = train_data2) %>%
  step_other(all_nominal_predictors(), threshold = 0.05) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_zv(all_predictors()) %>%
  step_corr(threshold = 0.7) %>%
  step_normalize(all_numeric_predictors())  # KNNä¸€å®šè¦normalizeï¼

# 1.3 Create Workflow
knn_wf2 <- workflow() %>%
  add_model(knn_spec2) %>%
  add_recipe(knn_recipe2)

# 1.4 Define Grid
knn_grid2 <- grid_regular(
  neighbors(range = c(3, 50)),
  levels = 10
)

# 1.5 Tune
knn_tuned2 <- tune_grid(
  knn_wf2,
  resamples = cross_validation_folds2,   # ç”¨æ–°çš„ folds2
  grid = knn_grid2,
  metrics = metric_set(roc_auc, accuracy)
)

# 1.6 Select best
knn_best2 <- select_best(knn_tuned2, metric = "roc_auc")

# 1.7 Finalize
final_knn_wf2 <- finalize_workflow(knn_wf2, knn_best2)

# 1.8 Last Fit
knn_final_fit2 <- last_fit(
  final_knn_wf2,
  split = data_split2,  metrics = metric_set( # ç›´æ¥åœ¨æ­¤æ“´å……æŒ‡æ¨™
    roc_auc, 
    accuracy,
    recall,     # æ–°å¢
    precision,  # æ–°å¢
    f_meas      # æ–°å¢
))

# 1.9 Collect metrics
collect_metrics(knn_final_fit2)

```


# Random Forest - clean version

```{r}
# Random Forest - clean version

# 2.1 Define Random Forest model
rf_spec2 <- rand_forest(
  mtry = tune(),
  min_n = tune()
) %>%
  set_engine("ranger", importance = "impurity") %>%
  set_mode("classification")

# 2.2 Define Recipeï¼ˆRFå¯ä»¥ä¸ç”¨normalizeï¼‰
rf_recipe2 <- recipe(attrition_flag ~ ., data = train_data2) %>%
  step_other(all_nominal_predictors(), threshold = 0.05) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_zv(all_predictors()) %>%
  step_corr(threshold = 0.7)

# 2.3 Create Workflow
rf_wf2 <- workflow() %>%
  add_model(rf_spec2) %>%
  add_recipe(rf_recipe2)

# 2.4 Define Grid
rf_grid2 <- grid_regular(
  mtry(range = c(2, 10)),
  min_n(range = c(5, 30)),
  levels = 5
)

# 2.5 Tune
rf_tuned2 <- tune_grid(
  rf_wf2,
  resamples = cross_validation_folds2,  # ç”¨æ–°çš„ folds2
  grid = rf_grid2,
  metrics = metric_set(roc_auc, accuracy)
)

# 2.6 Select best
rf_best2 <- select_best(rf_tuned2, metric = "roc_auc")

# 2.7 Finalize
final_rf_wf2 <- finalize_workflow(rf_wf2, rf_best2)

# Last fit
final_rf_fit2 <- last_fit(
  final_rf_wf2,
  split = data_split2,
  metrics = metric_set( # ç›´æ¥åœ¨æ­¤æ“´å……æŒ‡æ¨™
    roc_auc, 
    accuracy,
    recall,     # æ–°å¢
    precision,  # æ–°å¢
    f_meas      # æ–°å¢
))

# Collect metrics
collect_metrics(final_rf_fit2)

```



```{r}
# å…ˆè¼‰å¥½å¿…è¦çš„å¥—ä»¶
library(vip)

# ç•« Variable Importance Plot
final_rf_fit2 %>%
  extract_fit_parsnip() %>%
  vip(num_features = 20)  # åªåˆ—å‡ºå‰20é‡è¦çš„è®Šæ•¸

```

```{r}
# RF æ··æ·†çŸ©é™£
rf_conf_mat <- final_rf_fit2 %>%
  collect_predictions() %>%
  conf_mat(truth = attrition_flag, estimate = .pred_class)

rf_conf_mat

```


```{r}
tidy(rf_recipe2, number = 4) |> 
  filter(terms != "(Intercept)")

```


```{r}
# é¸æ•¸å€¼è®Šæ•¸
numeric_vars <- train_data2 %>% 
  select(where(is.numeric))
# ç®—ç›¸é—œçŸ©é™£
cor_matrix <- cor(numeric_vars, use = "complete.obs")

cor_matrix
# æ‰¾å‡ºç›¸é—œå¤§æ–¼0.7çš„è®Šæ•¸çµ„åˆ
cor_matrix[abs(cor_matrix) > 0.7 & abs(cor_matrix) < 1]

```







# XGBoost - clean version


```{r}
# 3.1 Define XGBoost model
xgb_spec2 <- boost_tree(
  trees = tune(),
  tree_depth = tune(),
  learn_rate = tune(),
  loss_reduction = tune(),
  sample_size = tune(),
  mtry = tune()
) %>%
  set_engine("xgboost") %>%
  set_mode("classification")

# 3.2 Define Recipeï¼ˆXGBä¹Ÿå¯ä»¥ä¸ç”¨normalizeï¼‰
xgb_recipe2 <- recipe(attrition_flag ~ ., data = train_data2) %>%
  step_other(all_nominal_predictors(), threshold = 0.05) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_zv(all_predictors()) %>%
  step_corr(threshold = 0.7)

# 3.3 Create Workflow
xgb_wf2 <- workflow() %>%
  add_model(xgb_spec2) %>%
  add_recipe(xgb_recipe2)

# 3.4 Define Grid
xgb_grid2 <- grid_latin_hypercube(
  trees(range = c(100, 1000)),
  tree_depth(range = c(2, 10)),
  learn_rate(range = c(0.01, 0.3)),
  loss_reduction(range = c(0.0001, 1)),
  sample_size = sample_prop(range = c(0.5, 1)),
  mtry(range = c(2, 10)),
  size = 20
)

# 3.5 Tune
xgb_tuned2 <- tune_grid(
  xgb_wf2,
  resamples = cross_validation_folds2,  # ç”¨ä¹¾æ·¨ç‰ˆ folds2
  grid = xgb_grid2,
  metrics = metric_set(roc_auc, accuracy)
)

# 3.6 Select best
xgb_best2 <- select_best(xgb_tuned2, metric = "roc_auc")

# 3.7 Finalize
final_xgb_wf2 <- finalize_workflow(xgb_wf2, xgb_best2)

# Last fit
final_xgb_fit2 <- last_fit(
  final_xgb_wf2,
  split = data_split2,
  metrics = metric_set( # ç›´æ¥åœ¨æ­¤æ“´å……æŒ‡æ¨™
    roc_auc, 
    accuracy,
    recall,     # æ–°å¢
    precision,  # æ–°å¢
    f_meas      # æ–°å¢
))

# Collect metrics
collect_metrics(final_xgb_fit2)

```



```{r}
# XGB æ··æ·†çŸ©é™£
xgb_conf_mat <- final_xgb_fit2 %>%
  collect_predictions() %>%
  conf_mat(truth = attrition_flag, estimate = .pred_class)

xgb_conf_mat

```




```{r}
# å¿«é€Ÿæ¯”è¼ƒæ‰€æœ‰æ¨¡å‹ (ç¯„ä¾‹ç¨‹å¼ç¢¼)
library(purrr)
list(
  logistic = final_base_fit2,
  ridge = final_ridge_fit2,
  lasso = final_lasso_fit2,
  elastic = final_elastic_fit2,
  knn = knn_final_fit2,
  rf = final_rf_fit2,
  xgb = final_xgb_fit2
) %>% 
  map_dfr(~collect_metrics(.x) %>% 
            select(.metric, .estimate) %>% 
            pivot_wider(names_from = .metric, values_from = .estimate),
          .id = "model") %>% 
  arrange(desc(roc_auc))
```


# Random Forest (SMOTEç‰ˆ)

```{r}
#install.packages("themis")

library(themis)  # ç”¨ SMOTE è¦æœ‰é€™å€‹ package

# æ–°ç‰ˆrecipe
smote_recipe2 <- recipe(attrition_flag ~ ., data = train_data2) %>% 
  step_other(all_nominal_predictors(), threshold = 0.05) %>%
  step_zv(all_predictors()) %>%
  step_corr(all_numeric_predictors(), threshold = 0.7) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_normalize(all_numeric_predictors()) %>%
  step_smote(attrition_flag)   # ğŸ”¥ åŠ ä¸Š SMOTE

```


```{r}

# Random Forestæ¨¡å‹è¨­å®š (ä¸ç”¨è®Š)
rf_spec2 <- rand_forest(
  mtry = tune(),
  min_n = tune()
) %>%
  set_engine("ranger", importance = "impurity") %>%
  set_mode("classification")

# Workflow (ç”¨ smote_recipe2)
rf_smote_wf2 <- workflow() %>%
  add_model(rf_spec2) %>%
  add_recipe(smote_recipe2)

# Grid
rf_grid2 <- grid_regular(
  mtry(range = c(2, 10)),
  min_n(range = c(5, 30)),
  levels = 5
)

# Tune
rf_smote_tuned2 <- tune_grid(
  rf_smote_wf2,
  resamples = cross_validation_folds2,
  grid = rf_grid2,
  metrics = metric_set(roc_auc, accuracy)
)

# Select best
rf_smote_best2 <- select_best(rf_smote_tuned2, metric = "roc_auc")

# Finalize
rf_smote_final_wf2 <- finalize_workflow(rf_smote_wf2, rf_smote_best2)

# Last Fit
rf_smote_final_fit2 <- last_fit(
  rf_smote_final_wf2,
  split = data_split2,
  metrics = metric_set(roc_auc, accuracy, recall, precision, f_meas)
)

# Collect metrics
collect_metrics(rf_smote_final_fit2)
```




```{r}
# XGBoostæ¨¡å‹è¨­å®š (ä¸ç”¨è®Š)
xgb_spec2 <- boost_tree(
  trees = tune(),
  tree_depth = tune(),
  learn_rate = tune(),
  loss_reduction = tune(),
  sample_size = tune(),
  mtry = tune()
) %>%
  set_engine("xgboost") %>%
  set_mode("classification")

# Workflow (ç”¨ smote_recipe2)
xgb_smote_wf2 <- workflow() %>%
  add_model(xgb_spec2) %>%
  add_recipe(smote_recipe2)

# Grid
xgb_grid2 <- grid_latin_hypercube(
  trees(range = c(100, 1000)),
  tree_depth(range = c(2, 10)),
  learn_rate(range = c(0.01, 0.3)),
  loss_reduction(range = c(0.0001, 1)),
  sample_size = sample_prop(range = c(0.5, 1)),
  mtry(range = c(2, 10)),
  size = 20
)

# Tune
xgb_smote_tuned2 <- tune_grid(
  xgb_smote_wf2,
  resamples = cross_validation_folds2,
  grid = xgb_grid2,
  metrics = metric_set(roc_auc, accuracy)
)

# Select best
xgb_smote_best2 <- select_best(xgb_smote_tuned2, metric = "roc_auc")

# Finalize
xgb_smote_final_wf2 <- finalize_workflow(xgb_smote_wf2, xgb_smote_best2)

# Last Fit
xgb_smote_final_fit2 <- last_fit(
  xgb_smote_final_wf2,
  split = data_split2,
  metrics = metric_set(roc_auc, accuracy, recall, precision, f_meas)
)

# Collect metrics
collect_metrics(xgb_smote_final_fit2)

```















# pca

```{r}
dim(train_data2)
```

```{r}
library(dplyr)

pca_varnames <- c(
  "customer_age",
  "total_trans_ct",
  "total_amt_chng_q4_q1",
  "avg_utilization_ratio",
  "credit_limit",
  "total_revolving_bal",
  "contacts_count_12_mon",
  "months_inactive_12_mon",
  "total_relationship_count"
)

train_numeric <- train_data2 %>%
  select(all_of(pca_varnames)) %>%
  na.omit()

# å†åš PCA
train_pca <- prcomp(train_numeric, center = TRUE, scale. = TRUE)

summary(train_pca)

```


```{r}
# å¾ test_data2 é¸ç›¸åŒæ•¸å€¼æ¬„ä½ï¼ˆè®Šæ•¸åç¨±è¦è·Ÿ train ç›¸åŒï¼‰
test_numeric <- test_data2 %>%  
  select(all_of(pca_varnames)) %>%
  na.omit()
# ç”¨ train çš„ PCA rotation å° test data åšæŠ•å½±ï¼ˆé æ¸¬ä¸»æˆåˆ†ï¼‰
test_pca_scores <- predict(train_pca, newdata = test_numeric)


```




```{r}
# Round the values in the rotation matrix of the PCA result to two decimal places
rounded_rotation <- round(train_pca$rotation, 2)

# Display the rotation matrix with rounded values
rounded_rotation
```
```{r}
# Display the values of the first row in the 'data' dataset
train_data2[1,]

# Display the loadings of the first principal component from the PCA rotation matrix
train_pca$rotation[, 1]

# Display the first few rows of the PCA scores matrix
head(train_pca$x) |> round(2)
```
```{r}
# è¨ˆç®—ä¸»æˆåˆ†çš„è²¢ç»æ¯”ä¾‹
variance_proportion <- train_pca$sdev^2 / sum(train_pca$sdev^2)

# æŠ˜ç·šåœ–ï¼ˆç°¡å–® base Rï¼‰
plot(variance_proportion, type = "b", main = "Proportion of Variance by PCs")

# Scree plot (fviz_eig)
library(factoextra)

fviz_eig(train_pca, addlabels = TRUE, ylim = c(0, 50),
         barfill = "darkred", barcolor = "red")

# åŠ å…¥ Kaiser rule åˆ¤ç·š
fviz_eig(train_pca, addlabels = TRUE, choice="eigenvalue", main = "Figure 2") +
  geom_hline(yintercept = 1, linetype = "dashed", color = "blue")

```


```{r}
expl_var <- round(variance_proportion[1:2] * 100, 1)
colnames(train_pca$x)[1:2] <- paste0("PC", 1:2, " (", expl_var, "%)")

```


ä¸»è¦ç›®çš„ï¼šè¦–è¦ºåŒ–é«˜ç¶­æ•¸æ“šçš„çµæ§‹
å°‡å¤šå€‹èˆ‡é¡§å®¢è¡Œç‚ºç›¸é—œçš„è®Šæ•¸ï¼ˆä¾‹å¦‚ï¼šäº¤æ˜“æ¬¡æ•¸ã€ä¿¡ç”¨é¡åº¦ã€ä½¿ç”¨æ¯”ä¾‹ï¼‰é™ç¶­åˆ°2ç¶­æˆ–3ç¶­ï¼Œæ–¹ä¾¿è§€å¯Ÿé¡§å®¢åˆ†ä½ˆèˆ‡ç¾¤é«”ç‰¹å¾µã€‚


```{r}
# é¸æ“‡æ•¸å€¼è®Šæ•¸ä¸¦æ¨™æº–åŒ–ï¼ˆtrain setï¼‰
pca_train_vars <- train_data2 %>%
  select(all_of(pca_varnames)) %>%
  na.omit()

# è¨˜å¾—ä¿ç•™å°æ‡‰çš„ label
train_labels <- train_data2 %>%
  filter(complete.cases(select(., all_of(pca_varnames)))) %>%
  pull(attrition_flag)

# åŸ·è¡Œ PCA
pca_result <- prcomp(pca_train_vars, center = TRUE, scale. = TRUE)

# çµ„åˆ PCA scores + labels
pca_data <- as.data.frame(pca_result$x[, 1:2])
pca_data$Attrition_Flag <- train_labels



library(ggplot2)

ggplot(pca_data, aes(x = PC1, y = PC2, color = Attrition_Flag)) +
  geom_point(alpha = 0.7, size = 2.5) +
  labs(title = "PCA of Customer Behavior (Training Set)",
       x = "Principal Component 1",
       y = "Principal Component 2",
       color = "Customer Status") +
  theme_minimal(base_size = 14)

```



```{r}
library(factoextra)

fviz_pca_biplot(pca_result,
                label = "var",
                habillage = train_labels,
                addEllipses = TRUE,
                col.var = "black",
                repel = TRUE,
                title = "PCA Biplot with Attrition (Train Only)")

```




# pca+logistic base model

```{r}

logistic_pca_recipe <- recipe(attrition_flag ~ ., data = train_data2) %>%
  step_select(all_of(c("attrition_flag", pca_varnames))) %>%     # âœ… ä¿ç•™ Y å’ŒæŒ‡å®šè®Šæ•¸
  step_normalize(all_of(pca_varnames)) %>%
  step_pca(all_of(pca_varnames), num_comp = 2)


# ä½¿ç”¨ç›¸åŒçš„ model
logistic_spec_pca <- logistic_reg() %>%
  set_engine("glm") %>%
  set_mode("classification")

# å»ºç«‹æ–°çš„ workflow
logistic_pca_wf <- workflow() %>%
  add_model(logistic_spec_pca) %>%
  add_recipe(logistic_pca_recipe)


logistic_pca_cv <- fit_resamples(
  logistic_pca_wf,
  resamples = cross_validation_folds2,
  metrics = metric_set(roc_auc, accuracy)
)

collect_metrics(logistic_pca_cv)


final_logistic_pca_fit <- last_fit(
  logistic_pca_wf,
  split = data_split2,
  metrics = metric_set(
    roc_auc,
    accuracy,
    recall,
    precision,
    f_meas
  )
)

collect_metrics(final_logistic_pca_fit)

```

# logistic baseline for pca compare

```{r}
# 
logistic_9vars_spec <- logistic_reg() %>%
  set_engine("glm") %>%
  set_mode("classification")

# 
pca_varnames <- c(
  "customer_age",
  "total_trans_ct",
  "total_amt_chng_q4_q1",
  "avg_utilization_ratio",
  "credit_limit",
  "total_revolving_bal",
  "contacts_count_12_mon",
  "months_inactive_12_mon",
  "total_relationship_count"
)

# 
logistic_9vars_recipe <- recipe(attrition_flag ~ ., data = train_data2) %>%
  step_select(all_of(c("attrition_flag", pca_varnames))) %>%  # ä¿ç•™æ¬„ä½
  step_zv(all_predictors()) %>%                                # å‰”é™¤ zero variance
  step_corr(all_predictors(), threshold = 0.7) %>%             # å‰ƒé™¤å…±ç·šæ€§
  step_normalize(all_predictors())                             # æ•¸å€¼æ¨™æº–åŒ–

# workflow
logistic_9vars_wf <- workflow() %>%
  add_model(logistic_9vars_spec) %>%
  add_recipe(logistic_9vars_recipe)

# cross-validation
logistic_9vars_cv <- fit_resamples(
  logistic_9vars_wf,
  resamples = cross_validation_folds2,
  metrics = metric_set(roc_auc, accuracy)
)

# 
collect_metrics(logistic_9vars_cv)

# last fit
final_logistic_9vars_fit <- last_fit(
  logistic_9vars_wf,
  split = data_split2,
  metrics = metric_set(roc_auc, accuracy, recall, precision, f_meas)
)

# çœ‹æ¸¬è©¦é›†æ•ˆèƒ½
collect_metrics(final_logistic_9vars_fit)

```



# Generative Model

# LDA

```{r}
#install.packages("discrim")

library(discrim)  

lda_spec <- discrim_linear() %>%
  set_engine("MASS") %>%
  set_mode("classification")
#
pca_varnames <- c(
  "customer_age",
  "total_trans_ct",
  "total_amt_chng_q4_q1",
  "avg_utilization_ratio",
  "credit_limit",
  "total_revolving_bal",
  "contacts_count_12_mon",
  "months_inactive_12_mon",
  "total_relationship_count"
)

#  
lda_recipe <- recipe(attrition_flag ~ ., data = train_data2) %>%
  step_select(all_of(c("attrition_flag", pca_varnames))) %>%
  step_normalize(all_numeric_predictors())

lda_wflow <- workflow() %>%
  add_recipe(lda_recipe) %>%
  add_model(lda_spec)

# Cross-validation
lda_cv <- fit_resamples(
  lda_wflow,
  resamples = cross_validation_folds2,
  metrics = metric_set(roc_auc, accuracy)
)

# Last fit for test set performance
final_lda_fit <- last_fit(
  lda_wflow,
  split = data_split2,
  metrics = metric_set(roc_auc, accuracy, recall, precision, f_meas)
)

collect_metrics(final_lda_fit)

```


| model              | AUC   | Accuracy | Recall | Precision | F1 Score |
|--------------------|-------|----------|--------|-----------|----------|
| **PCA + Logistic** | 0.7699 | 0.8539   | 0.1748 | 0.6786    | 0.2780   |
| **Logistic      ** | 0.8901 | 0.8889   | 0.4847 | 0.7349    | 0.5841   |
| **LDA**            | 0.8876 | 0.8904   | 0.5061 | 0.7301    | 0.5978   |


LDA åœ¨é€™è£¡çš„æ„ç¾©
å¯ç•¶ä½œä¸€ç¨®ç›£ç£å¼é™ç¶­çš„æ¯”è¼ƒå·¥å…·ï¼Œå¹«ä½ è§€å¯Ÿå“ªäº›æ–¹å‘æœ‰åˆ†é¡æ•ˆæœã€‚

ä¸å»ºè­°ç•¶ä½œå”¯ä¸€é æ¸¬åŸºç¤ï¼Œä½ å¯ä»¥ç”¨ LDA è¦–è¦ºåŒ–ã€æˆ–ç•¶æˆ baselineï¼Œä½†æ›´é«˜è¡¨ç¾çš„æ¨¡å‹é‚„æ˜¯ XGBoost æˆ– logistic + variable selection




```{r}
#è¼‰å…¥ discrim å¥—ä»¶ï¼ˆè‹¥å°šæœªå®‰è£ï¼Œå…ˆå®‰è£ï¼‰
# install.packages("discrim")
library(discrim)

# QDA æ¨¡å‹è¦æ ¼
qda_spec <- discrim_quad() %>%
  set_engine("MASS") %>%
  set_mode("classification")

# ç”¨èˆ‡ LDA ç›¸åŒçš„è®Šæ•¸èˆ‡è³‡æ–™è™•ç†
pca_varnames <- c(
  "customer_age",
  "total_trans_ct",
  "total_amt_chng_q4_q1",
  "avg_utilization_ratio",
  "credit_limit",
  "total_revolving_bal",
  "contacts_count_12_mon",
  "months_inactive_12_mon",
  "total_relationship_count"
)

qda_recipe <- recipe(attrition_flag ~ ., data = train_data2) %>%
  step_select(all_of(c("attrition_flag", pca_varnames))) %>%
  step_normalize(all_numeric_predictors())

# workflow
qda_wflow <- workflow() %>%
  add_recipe(qda_recipe) %>%
  add_model(qda_spec)

# 
qda_cv <- fit_resamples(
  qda_wflow,
  resamples = cross_validation_folds2,
  metrics = metric_set(roc_auc, accuracy)
)

# 
final_qda_fit <- last_fit(
  qda_wflow,
  split = data_split2,
  metrics = metric_set(roc_auc, accuracy, recall, precision, f_meas)
)

# 
collect_metrics(final_qda_fit)

```

ROC AUC é«˜é” 0.924ï¼Œè¡¨ç¤ºæ¨¡å‹èƒ½æœ‰æ•ˆå€åˆ†å…©é¡ã€‚

Recall ç‚º 0.586ï¼Œæ¯” LDA é‚„å¥½ï¼Œè¡¨ç¤ºå®ƒå°æµå¤±å®¢æˆ¶çš„æŠ“å–åŠ›æ›´å¼·ã€‚

æ•´é«”åœ¨ accuracyã€precisionã€F1 éƒ½å„ªæ–¼ baseline logistic å’Œ PCA logisticã€‚
